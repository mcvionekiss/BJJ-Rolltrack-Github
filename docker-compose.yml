version: '3.8'

# Simplified Docker Compose configuration for easier testing
# No need to specify alternate files - just use "docker-compose up"

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    env_file: ".env.testing"
    container_name: bjj-backend
    ports:
      - "8000:8000"
    volumes:
      # Exclude the entrypoint script from volume mounting
      - ./backend/server:/app/backend/server
      - ./backend/manage.py:/app/backend/manage.py
      - ./backend/requirements.txt:/app/backend/requirements.txt
    # Use explicit bash script instead of relying on ENTRYPOINT
    # This ensures proper execution regardless of file permissions
    command: bash -c "cd /app/backend && python manage.py migrate && python manage.py runserver 0.0.0.0:8000"
  
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    env_file: ".env.testing"
    container_name: bjj-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app/frontend
      - /app/frontend/node_modules
    depends_on:
      - backend
    # Run in development mode for easier debugging
    command: npm start